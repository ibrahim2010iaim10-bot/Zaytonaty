<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ - ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Ø®Ø· ÙŠØ¯Ø¹Ù… Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary-color: #3d5a28;
            --status-new: #fcd34d;      
            --status-in-progress: #60a5fa; 
            --status-completed: #34d399; 
        }
        * { font-family: 'Tajawal', sans-serif; }
        .header-bg { background-color: var(--primary-color); }
        .status-badge { 
            padding: 4px 10px; 
            border-radius: 9999px; 
            font-weight: bold; 
            font-size: 0.75rem; 
            color: #1a1a1a; 
            display: inline-block;
        }
        .new { background-color: var(--status-new); }
        .in-progress { background-color: var(--status-in-progress); }
        .completed { background-color: var(--status-completed); }
        .action-btn { transition: background-color 0.2s, transform 0.1s; }
        .action-btn:hover { transform: translateY(-1px); }
        .login-card { max-width: 400px; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

    <!-- Ù‚Ø³Ù… Ø§Ù„Ø±Ø£Ø³ (Header) -->
    <header class="header-bg text-white shadow-lg">
        <div class="max-w-7xl mx-auto py-4 px-4 flex justify-between items-center">
            <h1 class="text-3xl font-bold">Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ ğŸ› ï¸</h1>
            <button id="logout-button" class="text-sm border border-white px-3 py-1 rounded-full hover:bg-white hover:text-green-800 transition hidden">
                ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
            </button>
        </div>
    </header>

    <!-- ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¹Ø§Ù…Ø© -->
    <div id="messages" class="mb-4 hidden p-3 rounded-lg text-center font-semibold max-w-7xl mx-auto w-full mt-4"></div>

    <!-- 1. Ù†Ù…ÙˆØ°Ø¬ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (Login Form) -->
    <div id="login-container" class="flex-grow flex items-center justify-center p-6">
        <div class="login-card w-full bg-white shadow-2xl rounded-xl p-8">
            <h2 class="text-2xl font-bold mb-6 text-gray-700 text-center">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</h2>
            
            <form id="login-form">
                <div class="mb-4">
                    <label for="admin-email" class="block text-gray-700 text-sm font-bold mb-2">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</label>
                    <input type="email" id="admin-email" name="admin-email" required class="shadow appearance-none border rounded w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="admin@example.com">
                </div>
                <div class="mb-6">
                    <label for="admin-password" class="block text-gray-700 text-sm font-bold mb-2">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:</label>
                    <input type="password" id="admin-password" name="admin-password" required class="shadow appearance-none border rounded w-full py-3 px-4 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline" placeholder="********">
                </div>
                <div class="flex items-center justify-between">
                    <button type="submit" id="login-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline w-full transition">
                        ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                    </button>
                </div>
            </form>
            <p class="text-xs text-red-500 mt-4 text-center">ÙŠØ¬Ø¨ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯/ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙÙŠ Firebase.</p>
        </div>
    </div>

    <!-- 2. Ù…Ø­ØªÙˆÙ‰ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… (Admin Dashboard Content) -->
    <main id="dashboard-content" class="flex-grow max-w-7xl mx-auto w-full p-6 hidden">
        <h2 class="text-2xl font-bold mb-6 text-gray-700 border-b pb-2">Ù‚Ø§Ø¦Ù…Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ø±Ø§Ø¡</h2>
        
        <!-- Ø­Ø§ÙˆÙŠØ© Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª -->
        <div id="orders-container" class="bg-white shadow-2xl rounded-xl overflow-x-auto">
            <p id="loading-message" class="p-8 text-center text-gray-500">...Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</p>
            <p id="empty-message" class="hidden p-8 text-center text-gray-500 font-bold">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</p>
            
            <table class="min-w-full divide-y divide-gray-200 hidden" id="orders-table">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙˆØ§Ù„Ù…Ø¬Ù…ÙˆØ¹</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ÙŠØ©</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200" id="orders-table-body">
                    <!-- Ø³ÙŠØªÙ… Ø­Ù‚Ù† Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù‡Ù†Ø§ Ø¨ÙˆØ§Ø³Ø·Ø© JavaScript -->
                </tbody>
            </table>
        </div>
        
    </main>

    <!-- Ù‚Ø³Ù… Ø§Ù„ØªØ°ÙŠÙŠÙ„ (Footer) -->
    <footer class="header-bg text-white text-center py-3 mt-8">
        <p>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Olivey Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</p>
    </footer>

    <!-- Firebase SDKs and Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";
        
        // *************** Firebase Configuration (ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØµØ­ÙŠØ­Ø©) ***************
        const firebaseConfig = {
          apiKey: "AIzaSyBJX4iidOGIO_WiS6g-LFw89rrJ6ReInoM", 
          authDomain: "zaytonaty-f4240.firebaseapp.com",
          projectId: "zaytonaty-f4240",
          storageBucket: "zaytonaty-f4240.firebasestorage.app",
          messagingSenderId: "268778198002",
          appId: "1:268778198002:web:2803824e75be502f73916b",
          measurementId: "G-Y47CN3QHJ1"
        };
        // *******************************************************

        const STATUSES = {
            'Ø¬Ø¯ÙŠØ¯': { class: 'new', label: 'Ø¬Ø¯ÙŠØ¯' },
            'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°': { class: 'in-progress', label: 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°' },
            'Ù…ÙƒØªÙ…Ù„': { class: 'completed', label: 'Ù…ÙƒØªÙ…Ù„' }
        };

        let app, db, auth;

        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (e) {
            console.error("Failed to initialize Firebase:", e);
        }
        
        const ordersCollection = collection(db, "orders");
        
        // Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù…Ù† DOM
        const loginContainer = document.getElementById('login-container');
        const dashboardContent = document.getElementById('dashboard-content');
        const logoutButton = document.getElementById('logout-button');
        const loginForm = document.getElementById('login-form');
        const loginBtn = document.getElementById('login-btn');
        const messagesEl = document.getElementById('messages');

        // ÙˆØ¸ÙŠÙØ© Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
        function showMessage(text, isError = false) {
            if (!messagesEl) return;
            messagesEl.textContent = text;
            messagesEl.className = 'mb-4 p-3 rounded-lg text-center font-semibold max-w-7xl mx-auto w-full mt-4';
            messagesEl.style.display = 'block';
            if (isError) {
                messagesEl.classList.add('bg-red-200', 'text-red-800');
                messagesEl.classList.remove('bg-green-200', 'text-green-800');
            } else {
                messagesEl.classList.add('bg-green-200', 'text-green-800');
                messagesEl.classList.remove('bg-red-200', 'text-red-800');
            }
            setTimeout(() => {
                messagesEl.style.display = 'none';
            }, 5000); 
        }

        // Ø¹Ø±Ø¶/Ø¥Ø®ÙØ§Ø¡ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
        function toggleUI(isAuthenticated) {
            if (isAuthenticated) {
                loginContainer.classList.add('hidden');
                dashboardContent.classList.remove('hidden');
                logoutButton.classList.remove('hidden');
                messagesEl.style.display = 'none';
            } else {
                loginContainer.classList.remove('hidden');
                dashboardContent.classList.add('hidden');
                logoutButton.classList.add('hidden');
                const loadingMessage = document.getElementById('loading-message');
                if (loadingMessage) loadingMessage.style.display = 'none';
            }
        }


        // ÙˆØ¸ÙŠÙØ© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password').value;

            loginBtn.textContent = '...Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚';
            loginBtn.disabled = true;

            try {
                await signInWithEmailAndPassword(auth, email, password);
                showMessage('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­!', false);

            } catch (error) {
                console.error("Login Error:", error);
                let errorMessage = 'ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.';
                if (error.code === 'auth/wrong-password') {
                    errorMessage = 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.';
                } else if (error.code === 'auth/user-not-found') {
                    errorMessage = 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….';
                }
                showMessage(errorMessage, true);
            } finally {
                loginBtn.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
                loginBtn.disabled = false;
            }
        }

        // ÙˆØ¸ÙŠÙØ© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
        async function handleLogout() {
            try {
                await signOut(auth);
                showMessage('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­.', false);
                document.getElementById('admin-password').value = ''; 
            } catch (error) {
                console.error("Logout Error:", error);
                showMessage('ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬.', true);
            }
        }


        // ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ÙØ¹Ù„ÙŠ Ù„Ù„Ø·Ù„Ø¨Ø§Øª (Realtime Listener)
        function setupRealtimeListener() {
            const tableBody = document.getElementById('orders-table-body');
            const ordersTable = document.getElementById('orders-table');
            const loadingMessage = document.getElementById('loading-message');
            const emptyMessage = document.getElementById('empty-message');
            
            loadingMessage.style.display = 'block';

            onSnapshot(query(ordersCollection), (snapshot) => {
                loadingMessage.style.display = 'none';
                tableBody.innerHTML = '';
                
                if (snapshot.empty) {
                    ordersTable.classList.add('hidden');
                    emptyMessage.style.display = 'block';
                    return;
                }
                
                ordersTable.classList.remove('hidden');
                emptyMessage.style.display = 'none';

                snapshot.forEach(orderDoc => {
                    const order = orderDoc.data();
                    const orderId = orderDoc.id;
                    const statusData = STATUSES[order.status] || STATUSES['Ø¬Ø¯ÙŠØ¯'];

                    const itemsList = order.items.map(item => 
                        `<li>${item.name} (Ã—${item.quantity}) - ${item.price.toFixed(2)} Ø¬.Ù…</li>`
                    ).join('');

                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50 table-row-grid';
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${orderId.substring(0, 8)}...</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.date}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            <span class="font-bold">${order.buyer.name}</span><br>
                            <span class="text-xs text-gray-600">${order.buyer.phone}</span>
                            <div class="mt-1 font-bold text-gray-800">${order.total.toFixed(2)} Ø¬.Ù…</div>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-500 max-w-xs">
                            <ul class="list-disc list-inside text-xs">${itemsList}</ul>
                            <div class="mt-2 text-xs text-gray-600 font-bold border-t pt-1">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${order.buyer.address}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="status-badge ${statusData.class}" id="status-${orderId}">${statusData.label}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <select id="status-select-${orderId}" class="p-2 border rounded-md text-sm mb-2 w-full">
                                <option value="Ø¬Ø¯ÙŠØ¯" ${order.status === 'Ø¬Ø¯ÙŠØ¯' ? 'selected' : ''}>Ø¬Ø¯ÙŠØ¯</option>
                                <option value="Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°" ${order.status === 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°' ? 'selected' : ''}>Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</option>
                                <option value="Ù…ÙƒØªÙ…Ù„" ${order.status === 'Ù…ÙƒØªÙ…Ù„' ? 'selected' : ''}>Ù…ÙƒØªÙ…Ù„</option>
                            </select>
                            <button onclick="updateOrderStatus('${orderId}')" class="action-btn bg-blue-500 hover:bg-blue-600 text-white p-2 rounded-md text-xs font-semibold w-full">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©</button>
                            <button onclick="deleteOrderConfirmation('${orderId}')" class="action-btn bg-red-500 hover:bg-red-600 text-white p-2 rounded-md text-xs font-semibold mt-1 w-full">Ø­Ø°Ù</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            }, (error) => {
                loadingMessage.style.display = 'none';
                showMessage(`Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª. (ØªØ£ÙƒØ¯ Ù…Ù† Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø£Ù…Ø§Ù†).`, true);
                console.error("Firestore Listener Error: Check your Firestore Security Rules.", error);
            });
        }

        // Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª (ØªØ­Ø¯ÙŠØ«/Ø­Ø°Ù)
        window.updateOrderStatus = async function(orderId) {
            const selectElement = document.getElementById(`status-select-${orderId}`);
            const newStatus = selectElement.value;
            try {
                const orderRef = doc(db, "orders", orderId);
                await updateDoc(orderRef, { status: newStatus });
                showMessage(`ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ ${orderId.substring(0, 8)}... Ø¥Ù„Ù‰: ${newStatus}`, false);
            } catch (error) {
                showMessage('ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨.', true);
                console.error("Error updating order status: ", error);
            }
        }
        
        window.deleteOrderConfirmation = function(orderId) {
            const isConfirmed = prompt(`Ù„Ù„ØªØ£ÙƒÙŠØ¯ØŒ Ø§ÙƒØªØ¨ ÙƒÙ„Ù…Ø© "Ø­Ø°Ù" Ù„Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨ ${orderId.substring(0, 8)}... Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹:`);
            if (isConfirmed === "Ø­Ø°Ù") {
                deleteOrder(orderId);
            } else if (isConfirmed !== null) {
                showMessage('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø­Ø°Ù. ÙƒÙ„Ù…Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯ ØºÙŠØ± ØµØ­ÙŠØ­Ø©.', true);
            }
        };

        async function deleteOrder(orderId) {
            try {
                const orderRef = doc(db, "orders", orderId);
                await deleteDoc(orderRef);
                showMessage(`ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨ ${orderId.substring(0, 8)}... Ø¨Ù†Ø¬Ø§Ø­.`, false);
            } catch (error) {
                showMessage('ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨.', true);
                console.error("Error deleting order: ", error);
            }
        }


        // Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        function initAdminDashboard() {
            if (!auth) return;

            // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    toggleUI(true);
                    setupRealtimeListener();
                } else {
                    toggleUI(false);
                }
            });

            loginForm.addEventListener('submit', handleLogin);
            logoutButton.addEventListener('click', handleLogout);
        }

        window.onload = initAdminDashboard;
    </script>
</body>
</html>
