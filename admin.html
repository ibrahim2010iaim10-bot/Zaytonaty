<!DOCTYPE html>
<html lang="ar" dir="rtl" id="main-html">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard - Zaytonaty</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Ø£Ù„ÙˆØ§Ù† Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø·Ù„Ø¨ */
        .status-badge { padding: 5px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; color: white; display: inline-block; }
        .status-new { background-color: #f39c12; }      /* Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ Ù„Ù„Ø¬Ø¯ÙŠØ¯ */
        .status-process { background-color: #3498db; }  /* Ø£Ø²Ø±Ù‚ Ù„Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ° */
        .status-done { background-color: #27ae60; }     /* Ø£Ø®Ø¶Ø± Ù„Ù„Ù…Ù†ØªÙ‡ÙŠ */
        
        select.status-select { padding: 5px; border-radius: 8px; border: 1px solid #ddd; font-family: 'Tajawal', sans-serif; cursor: pointer; }
    </style>
</head>
<body>
    <header>
        <a href="index.html" class="logo">Zaytonaty ğŸ”’ Admin</a>
        <nav><button onclick="logout()" class="lang-btn" style="border-color:red; color:red;">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button></nav>
    </header>

    <div id="login-ui" class="container" style="text-align:center; padding-top:50px;">
        <div class="shipping-form" style="max-width:400px; margin:auto;">
            <h2>Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</h2>
            <input type="email" id="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
            <input type="password" id="pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            <button class="cta-btn" style="width:100%" onclick="login()">Ø¯Ø®ÙˆÙ„</button>
        </div>
    </div>

    <div id="admin-ui" class="container" style="display:none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©</h2>
        </div>
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                        <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                        <th>Ø§Ù„ØªÙØ§ØµÙŠÙ„</th>
                        <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                        <th>Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</th>
                        <th>ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©</th>
                    </tr>
                </thead>
                <tbody id="admin-body"></tbody>
            </table>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, orderBy, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBJX4iidOGIO_WiS6g-LFw89rrJ6ReInoM",
            authDomain: "zaytonaty-f4240.firebaseapp.com",
            projectId: "zaytonaty-f4240",
            appId: "1:268778198002:web:2803824e75be502f73916b"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø¯Ø®ÙˆÙ„
        window.login = () => {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('pass').value;
            signInWithEmailAndPassword(auth, email, pass).catch(e => alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"));
        };

        // ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø®Ø±ÙˆØ¬
        window.logout = () => signOut(auth);

        // ÙˆØ¸ÙŠÙØ© ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ Firebase
        window.updateStatus = async (orderId, newStatus) => {
            try {
                const orderRef = doc(db, "orders", orderId);
                await updateDoc(orderRef, { status: newStatus });
                // Ù„Ø§ Ù†Ø­ØªØ§Ø¬ Ù„Ø¹Ù…Ù„ Refresh Ù„Ø£Ù† onSnapshot Ø³ÙŠÙ‚ÙˆÙ… Ø¨Ø§Ù„ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
            } catch (e) {
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©");
            }
        };

        // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        onAuthStateChanged(auth, user => {
            if(user) {
                document.getElementById('login-ui').style.display='none';
                document.getElementById('admin-ui').style.display='block';
                
                onSnapshot(query(collection(db, "orders"), orderBy("date", "desc")), s => {
                    document.getElementById('admin-body').innerHTML = s.docs.map(d => {
                        const o = d.data();
                        const id = d.id;
                        const status = o.status || "Ø¬Ø¯ÙŠØ¯"; // Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù‡Ùˆ Ø¬Ø¯ÙŠØ¯

                        // ØªØ­Ø¯ÙŠØ¯ Ù„ÙˆÙ† Ø§Ù„Ø­Ø§Ù„Ø©
                        let statusClass = "status-new";
                        if(status === "Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°") statusClass = "status-process";
                        if(status === "Ù…Ù†ØªÙ‡ÙŠ") statusClass = "status-done";

                        return `
                        <tr>
                            <td>${o.date}</td>
                            <td><strong>${o.customer_name}</strong><br><small>${o.phone}</small></td>
                            <td><small>${o.address}<br>(${o.items.map(i=>i.name).join(', ')})</small></td>
                            <td>${o.total} Ø¬.Ù…</td>
                            <td><span class="status-badge ${statusClass}">${status}</span></td>
                            <td>
                                <select class="status-select" onchange="updateStatus('${id}', this.value)">
                                    <option value="Ø¬Ø¯ÙŠØ¯" ${status === 'Ø¬Ø¯ÙŠØ¯' ? 'selected' : ''}>Ø¬Ø¯ÙŠØ¯</option>
                                    <option value="Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°" ${status === 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°' ? 'selected' : ''}>Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</option>
                                    <option value="Ù…Ù†ØªÙ‡ÙŠ" ${status === 'Ù…Ù†ØªÙ‡ÙŠ' ? 'selected' : ''}>Ù…Ù†ØªÙ‡ÙŠ</option>
                                </select>
                            </td>
                        </tr>`;
                    }).join('');
                });
            } else {
                document.getElementById('login-ui').style.display='block';
                document.getElementById('admin-ui').style.display='none';
            }
        });
    </script>
</body>
</html>
